{% extends "gymapp/base.html" %}
{% load static %}

{% block contenido %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
            <h2 class="text-center mb-4">Tu carrito de compras</h2>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Mancuerna</th>
                            <th>Cantidad</th>
                            <th>Precio unitario</th>
                            <th>Precio total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart %}
                            <tr>
                                <td>{{ item.mancuerna.peso }} kg</td>
                                <td>
                                    <form action="{% url 'cart_add' item.mancuerna.id %}" method="post">
                                        {% csrf_token %}
                                        <input type="number" name="quantity" id="quantity-{{ forloop.counter0 }}" class="form-control form-control-sm d-inline-block w-auto" data-unit-price="{{ item.price }}" value="{{ item.quantity }}" min="1" onchange="this.form.submit()">
                                    </form>
                                </td>
                                <td>${{ item.price }}</td>
                                <td id="total-price-{{ forloop.counter0 }}">${{ item.total_price }}</td>
                                <td>
                                    <form action="{% url 'cart_remove' item.mancuerna.id %}" method="post">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="3"><strong>Total</strong></td>
                            <td><strong id="cart-total">${{ cart.get_total_price }}</strong></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'lista_mancuernas' %}" class="btn btn-primary" style="background-color: #7241b4; color: white; border-color: #7241b4;">Seguir comprando</a>
                <a href="{% url 'direccion_entrega' %}" class="btn btn-dark">Continuar</a>
            </div>
        </div>
    </div>
</div>

<script>
    function updatePrice(index) {
        let quantityInput = document.getElementById('quantity-' + index);
        let unitPrice = parseFloat(quantityInput.getAttribute('data-unit-price'));
        let quantity = parseInt(quantityInput.value);
        let totalPriceElement = document.getElementById('total-price-' + index);
        let newTotalPrice = unitPrice * quantity;
        totalPriceElement.innerText = '$' + newTotalPrice.toFixed(2);

        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0;
        let totalElements = document.querySelectorAll('[id^="total-price-"]');
        totalElements.forEach(function(element) {
            total += parseFloat(element.innerText.replace('$', ''));
        });
        let cartTotalElement = document.getElementById('cart-total');
        cartTotalElement.innerText = '$' + total.toFixed(2);
    }
</script>
{% endblock %}
